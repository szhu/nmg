#!/bin/bash
# This tool creates a disk image to put node_modules in. This makes it so that
# when the disk image is not mounted, it is treated as a single file by
# Spotlight and other tools to do expensive tasks on a per-file basis.

set -e

init() {
  hdiutil create -size '1G' -type 'SPARSE' -volname 'node_modules' 'node_modules.sparseimage'
}

attach() {
  hdiutil attach 'node_modules.sparseimage' -mountpoint 'node_modules' -nobrowse
}

migrate() {
  detach || true
  mv 'node_modules' 'node_modules~'
  attach
  ditto 'node_modules~' 'node_modules'
  rm -rf 'node_modules~'
  mkdir 'node_modules'
  chmod -x 'node_modules'
}

detach() {
  hdiutil detach 'node_modules'
}

# If $1 matches any of these:
case "$1" in
init) init ;;
attach) attach ;;
migrate) migrate ;;
detach) detach ;;
*) echo "Usage: $0 [init | attach | migrate | detach]" ;;
esac
